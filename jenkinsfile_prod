pipeline {
    agent any

    environment {
        DOCKER_IMAGE = 'qriz-dkt'
        DOCKER_TAG = "prod-${BUILD_NUMBER}"
        AWS_REGION = 'ap-northeast-2'
        ECR_REGISTRY = '314146328505.dkr.ecr.ap-northeast-2.amazonaws.com'
        AWS_CREDENTIALS = 'aws-credentials'
        ENV_FILE = 'prod-env-file'  // ìš´ì˜ í™˜ê²½ìš© í™˜ê²½ íŒŒì¼
        ASG_NAME = 'prod-flask-asg'  // ìš´ì˜ í™˜ê²½ ASG ì´ë¦„
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', credentialsId: 'github-token', url: 'https://github.com/Project-Qriz/DKT.git'
            }
        }

        stage('Build Docker Image') {
            steps {
                withCredentials([file(credentialsId: 'prod-env-file', variable: 'ENV_FILE')]) {
                    // ìš´ì˜ í™˜ê²½ ì„¤ì • íŒŒì¼ ë³µì‚¬
                    sh "cat \${ENV_FILE} > .prod.env"

                    sh """
                        docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                        docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${ECR_REGISTRY}/qriz/dkt:${DOCKER_TAG}
                        docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${ECR_REGISTRY}/qriz/dkt:main
                    """
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    withCredentials([[
                        $class: 'AmazonWebServicesCredentialsBinding',
                        credentialsId: "${AWS_CREDENTIALS}",
                        accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                        secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                    ]]) {
                        sh """
                            aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}
                            docker push ${ECR_REGISTRY}/qriz/dkt:${DOCKER_TAG}
                            docker push ${ECR_REGISTRY}/qriz/dkt:main
                        """
                    }
                }
            }
        }

        stage('Deploy to ASG') {
            steps {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: "${AWS_CREDENTIALS}",
                    accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                    secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                ]]) {
                    // ASG ì¸ìŠ¤í„´ìŠ¤ ë¦¬í”„ë ˆì‹œ ì‹œì‘
                    sh """
                        aws autoscaling start-instance-refresh \\
                          --auto-scaling-group-name ${ASG_NAME} \\
                          --preferences '{"MinHealthyPercentage": 50, "InstanceWarmup": 300}'
                    """

                    // ì¸ìŠ¤í„´ìŠ¤ ë¦¬í”„ë ˆì‹œ ìƒíƒœ í™•ì¸
                    sh """
                        echo "ì¸ìŠ¤í„´ìŠ¤ ë¦¬í”„ë ˆì‹œ ìƒíƒœ í™•ì¸ ì¤‘..."
                        aws autoscaling describe-instance-refreshes \\
                          --auto-scaling-group-name ${ASG_NAME} \\
                          --limit 1
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'ìš´ì˜ í™˜ê²½ Flask DKT ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!'
            slackSend(
                color: 'good',
                message: "ğŸš€ ìš´ì˜ DKT ë°°í¬ ì„±ê³µ - ${env.JOB_NAME} #${env.BUILD_NUMBER} (<${env.BUILD_URL}|ìƒì„¸ ë³´ê¸°>)\nì´ë¯¸ì§€: ${ECR_REGISTRY}/qriz/dkt:${DOCKER_TAG}"
            )
        }
        failure {
            echo 'ìš´ì˜ í™˜ê²½ DKT ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
            slackSend(
                color: 'danger',
                message: "âŒ ìš´ì˜ DKT ë°°í¬ ì‹¤íŒ¨ - ${env.JOB_NAME} #${env.BUILD_NUMBER} (<${env.BUILD_URL}|ìƒì„¸ ë³´ê¸°>)"
            )

            // ì‹¤íŒ¨ ì‹œ ìë™ ë¡¤ë°± ë¡œì§
            script {
                try {
                    withCredentials([[
                        $class: 'AmazonWebServicesCredentialsBinding',
                        credentialsId: "${AWS_CREDENTIALS}",
                        accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                        secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                    ]]) {
                        // ì´ì „ ì„±ê³µí•œ ë¹Œë“œ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
                        def lastSuccessfulBuild = currentBuild.previousSuccessfulBuild?.number ?: (currentBuild.number - 1)
                        def previousTag = "prod-${lastSuccessfulBuild}"

                        echo "ì´ì „ ì„±ê³µ ë°°í¬(${previousTag})ë¡œ ë¡¤ë°±í•©ë‹ˆë‹¤."

                        // ë¡¤ë°± ì•Œë¦¼
                        slackSend(
                            color: 'warning',
                            message: "âš ï¸ ìš´ì˜ DKT ìë™ ë¡¤ë°± ì¤‘ - ì´ì „ ë²„ì „(${previousTag})ìœ¼ë¡œ ë³µêµ¬í•©ë‹ˆë‹¤."
                        )

                        // ASG ë¡¤ë°± (ì¸ìŠ¤í„´ìŠ¤ ë¦¬í”„ë ˆì‹œë¥¼ ë‹¤ì‹œ ì‹œì‘í•˜ë©´ ë¨)
                        sh """
                            aws autoscaling start-instance-refresh \\
                              --auto-scaling-group-name ${ASG_NAME} \\
                              --preferences '{"MinHealthyPercentage": 50, "InstanceWarmup": 300}'
                        """
                    }
                } catch (Exception e) {
                    echo "ë¡¤ë°± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}"
                    slackSend(
                        color: 'danger',
                        message: "â›” ìš´ì˜ DKT ë¡¤ë°± ì‹¤íŒ¨ - ìˆ˜ë™ ê°œì…ì´ í•„ìš”í•©ë‹ˆë‹¤."
                    )
                }
            }
        }
        always {
            // ì‘ì—… ê³µê°„ ì •ë¦¬
            cleanWs()
        }
    }
}